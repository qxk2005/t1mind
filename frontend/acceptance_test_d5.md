# 任务D5：端到端验收测试

## 概述
本文档提供了AI全局模型OpenAI兼容功能的完整验收测试指南，验证所有里程碑功能是否正常工作。

## 测试环境准备

### 前置条件
1. AppFlowy 应用已构建并运行
2. 准备测试用的OpenAI兼容API服务器（如Ollama、LocalAI等）
3. 准备有效的API密钥（用于测试，不要使用生产密钥）

### 安全注意事项
⚠️ **重要**: 
- 不要在代码中硬编码真实的API密钥
- 使用测试环境的API密钥
- 测试完成后清理敏感信息

## 里程碑A：UI与i18n验收测试

### A1-A3: 全局模型类型选择和面板切换

#### 测试步骤：
1. **打开AI设置页面**
   - 导航到 设置 > AI设置
   - 验证页面正常加载

2. **验证全局模型类型选择器**
   - 查看"全局使用的模型类型"下拉选择器
   - 验证选项包含：
     - "ollama 本地"（默认选中）
     - "openai 兼容服务器"
   - 验证选择器可以正常点击和选择

3. **验证面板切换功能**
   - 默认状态：选择"ollama 本地"，应显示现有的LocalAISetting面板
   - 切换到"openai 兼容服务器"，应显示OpenAICompatibleSetting面板
   - 来回切换，验证面板正确显示

4. **验证OpenAI兼容设置面板结构**
   - 聊天配置区域包含：
     - API端点（默认值：https://api.openai.com/v1）
     - API密钥（遮蔽显示）
     - 模型名称（默认值：gpt-3.5-turbo）
     - 模型类型（默认值：chat）
     - 最大Tokens（默认值：4096）
     - 温度（默认值：0.7）
     - 请求超时（默认值：30）
   - 嵌入配置区域包含：
     - API端点（默认值：https://api.openai.com/v1）
     - API密钥（遮蔽显示）
     - 模型名称（默认值：text-embedding-ada-002）
   - 操作按钮：测试聊天、测试嵌入、保存设置

#### 预期结果：
✅ 所有UI元素正确显示  
✅ 下拉选择器工作正常  
✅ 面板切换无错误  
✅ 所有字段可以输入  
✅ 密钥字段正确遮蔽  

### A4: 移动端设置入口

#### 测试步骤：
1. 在移动端设备或模拟器上打开AppFlowy
2. 导航到AI设置
3. 验证全局模型类型选择功能可用

#### 预期结果：
✅ 移动端可访问全局模型类型设置  
✅ 功能与桌面端一致  

### A5: 国际化文案

#### 测试步骤：
1. 切换语言到中文，验证所有文案正确显示
2. 切换语言到英文，验证所有文案正确显示
3. 重点验证：
   - 全局模型类型相关文案
   - OpenAI兼容设置相关文案
   - 按钮和提示文案

#### 预期结果：
✅ 中英文界面文案正确显示  
✅ 无缺失或错误的翻译  

## 里程碑B：持久化验收测试

### B1-B6: 配置保存和读取

#### 测试步骤：
1. **配置OpenAI兼容设置**
   - 选择"openai 兼容服务器"
   - 填写聊天配置：
     - API端点：`http://localhost:11434/v1`（或其他测试服务器）
     - API密钥：`test-key-123`
     - 模型名称：`llama2`
     - 其他参数使用默认值
   - 填写嵌入配置：
     - API端点：`http://localhost:11434/v1`
     - API密钥：`test-key-123`
     - 模型名称：`nomic-embed-text`

2. **保存配置**
   - 点击"保存设置"按钮
   - 验证显示成功提示

3. **验证配置持久化**
   - 刷新页面或重新打开设置
   - 验证所有配置正确保存
   - 全局模型类型应保持为"openai 兼容服务器"
   - 所有字段值应正确显示

4. **重启应用验证**
   - 完全关闭应用
   - 重新启动应用
   - 打开AI设置页面
   - 验证配置仍然保存

#### 预期结果：
✅ 配置可以成功保存  
✅ 页面刷新后配置保持  
✅ 应用重启后配置保持  
✅ 全局模型类型正确保存  

## 里程碑C：测试能力验收测试

### C1-C6: 连接测试功能

#### 测试步骤：
1. **准备测试环境**
   - 确保有可用的OpenAI兼容API服务器
   - 配置正确的API端点和密钥

2. **测试聊天功能**
   - 在OpenAI兼容设置中点击"测试聊天"
   - 观察按钮状态变为"测试中..."
   - 等待测试结果

3. **测试嵌入功能**
   - 点击"测试嵌入"按钮
   - 观察按钮状态变为"测试中..."
   - 等待测试结果

4. **验证成功场景**
   - 成功时应显示绿色提示框
   - 包含响应时间信息
   - 可以点击"详情"查看完整信息

5. **验证错误场景**
   - 故意配置错误的端点（如`http://invalid-url`）
   - 测试应返回连接错误
   - 验证错误信息用户友好
   - 测试不同错误类型：
     - 网络连接错误
     - 认证错误（错误API密钥）
     - 模型不存在错误
     - 超时错误

6. **验证错误信息本地化**
   - 验证错误提示有中英文版本
   - 错误信息应该用户友好，不包含技术细节

#### 预期结果：
✅ 测试按钮正确显示加载状态  
✅ 成功测试显示绿色提示和响应时间  
✅ 失败测试显示红色提示和具体错误  
✅ 错误信息用户友好且本地化  
✅ 详情对话框显示完整测试信息  

## 里程碑D：全局生效验收测试

### D1-D4: 全局路由切换

#### 测试步骤：
1. **验证聊天路由切换**
   - 确保全局模型类型设置为"openai 兼容服务器"
   - 打开AI聊天功能
   - 发送一条消息
   - 验证请求路由到OpenAI兼容服务器
   - 切换回"ollama 本地"
   - 再次发送消息
   - 验证请求路由到本地AI

2. **验证嵌入路由切换**
   - 设置全局模型类型为"openai 兼容服务器"
   - 尝试文档嵌入功能
   - 验证嵌入请求路由到OpenAI兼容服务器
   - 切换回"ollama 本地"
   - 再次尝试嵌入
   - 验证请求路由到本地AI

3. **验证流式聊天**
   - 使用OpenAI兼容配置
   - 发送较长的聊天请求
   - 验证响应是流式返回
   - 验证流式体验与本地AI一致

4. **验证错误回退**
   - 配置无效的OpenAI兼容服务器
   - 发送聊天请求
   - 验证自动回退到本地AI（如果可用）

#### 预期结果：
✅ 全局切换能正确路由聊天请求  
✅ 全局切换能正确路由嵌入请求  
✅ 流式聊天功能正常  
✅ 错误时能正确回退  

### 日志验证
检查应用日志，验证：
- 路由决策日志正确
- API密钥在日志中已脱敏
- 错误处理日志完整

## 跨平台一致性测试

### 测试平台
- [ ] Windows 桌面端
- [ ] macOS 桌面端  
- [ ] Linux 桌面端
- [ ] iOS 移动端
- [ ] Android 移动端

### 验证项目
对每个平台验证：
1. UI显示一致性
2. 功能完整性
3. 配置保存
4. 测试功能
5. 全局路由

## 安全性验证

### API密钥安全
1. **存储安全**
   - 验证API密钥加密存储
   - 验证密钥不以明文形式存储

2. **显示安全**
   - 验证UI中密钥字段遮蔽显示
   - 验证复制粘贴时的安全处理

3. **日志安全**
   - 检查应用日志
   - 验证API密钥已脱敏
   - 验证敏感信息不泄露

## 性能验证

### 响应时间
- UI切换响应时间 < 100ms
- 配置保存时间 < 1s
- 测试连接时间合理（取决于网络）

### 资源使用
- 内存使用无异常增长
- CPU使用正常
- 网络请求合理

## 回归测试

### 现有功能验证
确保新功能不影响现有功能：
1. 本地AI功能正常
2. 原有聊天功能正常
3. 原有嵌入功能正常
4. 其他AI相关功能正常

## 测试报告模板

### 测试执行记录
```
测试日期：____
测试人员：____
测试环境：____
AppFlowy版本：____

里程碑A - UI与i18n：
□ A1: 全局模型类型选择器 - 通过/失败
□ A2: OpenAI兼容设置面板 - 通过/失败  
□ A3: Tab切换逻辑 - 通过/失败
□ A4: 移动端设置入口 - 通过/失败
□ A5: 基础i18n文案 - 通过/失败

里程碑B - 持久化：
□ B1-B6: 配置保存读取 - 通过/失败

里程碑C - 测试能力：
□ C1-C6: 连接测试功能 - 通过/失败

里程碑D - 全局生效：
□ D1-D4: 全局路由切换 - 通过/失败

跨平台测试：
□ Windows - 通过/失败
□ macOS - 通过/失败  
□ Linux - 通过/失败
□ iOS - 通过/失败
□ Android - 通过/失败

安全性测试：
□ API密钥安全存储 - 通过/失败
□ 日志脱敏 - 通过/失败

性能测试：
□ 响应时间 - 通过/失败
□ 资源使用 - 通过/失败

回归测试：
□ 现有功能无影响 - 通过/失败
```

### 问题记录
如发现问题，记录：
- 问题描述
- 重现步骤  
- 预期结果
- 实际结果
- 严重程度
- 截图/日志

## 验收标准

### 必须通过项（阻塞发布）
- [ ] 所有UI功能正常显示和交互
- [ ] 配置能正确保存和读取
- [ ] 测试功能返回正确结果
- [ ] 全局路由切换工作正常
- [ ] API密钥安全存储
- [ ] 无功能回归

### 应该通过项（建议修复）
- [ ] 所有平台功能一致
- [ ] 性能表现良好
- [ ] 错误提示用户友好
- [ ] 国际化完整

### 可以接受项（后续优化）
- [ ] UI细节优化
- [ ] 性能进一步优化
- [ ] 更多错误场景覆盖

## 总结

完成所有测试项目后，确认：
1. 所有里程碑功能正常工作
2. 用户体验良好
3. 安全性得到保障
4. 性能表现可接受
5. 无功能回归

如果所有必须通过项都满足，则任务D5验收测试通过。
