# MCP一键检查功能 - 快速测试指南

## 功能位置

**设置 → 工作空间 → MCP配置** 部分

## 新增功能

### 1. 一键检查按钮 🔍

**位置**：MCP服务器列表标题栏
```
┌─────────────────────────────────────────────────┐
│  MCP 服务器列表    [一键检查]  [添加服务器]    │
└─────────────────────────────────────────────────┘
```

**功能**：
- 自动连接所有未连接的服务器
- 自动加载所有服务器的工具列表
- 显示"正在检查 N 个服务器..."的提示

### 2. 工具标签显示 🏷️

**位置**：每个服务器卡片的底部

**显示规则**：
- ✅ 只在服务器已连接且有工具时显示
- ✅ 最多显示5个工具标签
- ✅ 超过5个时显示 "+N" 标签

**标签样式**：
```
┌────────────────────────────────────────┐
│ My MCP Server              STDIO   📋  │
│ 这是一个示例MCP服务器                  │
│ 命令: /usr/local/bin/mcp-server        │
│                                        │
│ 🔧 search  🔧 query  🔧 analyze        │
│ 🔧 fetch   🔧 write  +3               │
└────────────────────────────────────────┘
```

### 3. 工具描述悬停 💭

**交互**：鼠标悬停在工具标签上

**效果**：
- 标签背景色变亮（变为primaryContainer）
- 标签边框变为主题色
- 文字加粗并变为主题色
- 显示Tooltip，包含工具名称和完整描述

**Tooltip格式**：
```
┌──────────────────────────┐
│ search                   │
│                          │
│ 在文档中搜索指定的内容， │
│ 支持正则表达式和模糊匹配 │
└──────────────────────────┘
```

## 测试步骤

### 准备工作

1. **添加测试服务器**
   ```bash
   # 可以添加任意MCP兼容服务器
   # 例如：Excel MCP、文件系统MCP等
   ```

2. **确保至少有2-3个MCP服务器配置**
   - 可以是STDIO类型
   - 也可以是HTTP/SSE类型

### 测试场景 1：一键检查功能

**步骤**：
1. ✅ 打开MCP配置页面
2. ✅ 确保有未连接的服务器
3. ✅ 点击"一键检查"按钮
4. ✅ 观察：
   - 是否显示"正在检查 N 个服务器..."提示
   - 服务器是否开始连接（状态图标变化）
   - 连接成功后是否自动加载工具

**预期结果**：
- ✅ 所有服务器自动连接
- ✅ 工具自动加载并显示
- ✅ 显示提示消息

### 测试场景 2：工具标签显示

**步骤**：
1. ✅ 确保至少一个服务器已连接并有工具
2. ✅ 观察服务器卡片底部

**测试用例**：

| 工具数量 | 预期显示 |
|---------|---------|
| 0个工具 | 不显示标签区域 |
| 1-5个工具 | 显示所有工具标签 |
| 超过5个工具 | 显示前5个 + "+N" |

**预期结果**：
- ✅ 标签正确显示
- ✅ 每个标签有工具图标和名称
- ✅ 布局整齐，自动换行

### 测试场景 3：悬停交互

**步骤**：
1. ✅ 将鼠标移动到任意工具标签上
2. ✅ 等待约300ms

**观察项**：
- ✅ 标签背景色是否变化
- ✅ 标签边框是否变化
- ✅ 文字是否加粗
- ✅ 是否显示Tooltip
- ✅ Tooltip内容是否包含工具名称和描述
- ✅ 动画是否流畅

**预期结果**：
- ✅ 视觉反馈明显
- ✅ Tooltip正确显示
- ✅ 过渡动画流畅

### 测试场景 4：边界情况

**测试用例**：

1. **无服务器**
   - ✅ 显示空状态
   - ✅ "一键检查"按钮不应出现

2. **所有服务器已连接**
   - ✅ 点击"一键检查"
   - ✅ 应刷新工具列表

3. **服务器连接失败**
   - ✅ 显示错误提示
   - ✅ 不显示工具标签

4. **工具描述为空**
   - ✅ Tooltip只显示工具名称

## 常见问题排查

### Q1: 点击"一键检查"后没有反应？

**排查**：
1. 检查MCP服务器配置是否正确
2. 查看浏览器控制台是否有错误
3. 确认后端MCP服务是否正常运行

### Q2: 工具标签不显示？

**排查**：
1. 确认服务器是否已连接（绿色圆点）
2. 检查是否有工具数量徽章
3. 手动点击"刷新工具"按钮

### Q3: Tooltip不显示？

**排查**：
1. 确保鼠标完全移入标签区域
2. 等待300ms延迟时间
3. 检查是否有其他元素遮挡

## 性能指标

- ✅ 工具标签加载：< 100ms
- ✅ 悬停动画：150ms
- ✅ Tooltip延迟：300ms
- ✅ 一键检查：取决于服务器数量，每个约1-3秒

## 相关代码文件

```
appflowy_flutter/lib/
  ├── workspace/presentation/settings/workspace/
  │   └── workspace_mcp_settings_v2.dart  # 主要实现文件
  └── plugins/ai_chat/application/
      └── mcp_settings_bloc.dart          # 状态管理
```

## UI截图说明

### 一键检查按钮位置
```
┌────────────────────────────────────────────────────┐
│  MCP 服务器列表                                     │
│                    [🔍 一键检查]  [➕ 添加服务器]   │
└────────────────────────────────────────────────────┘
```

### 工具标签展示
```
┌──────────────────────────────────────────────────┐
│  Excel MCP Server                    STDIO  📋   │
│  Microsoft Excel操作服务器                        │
│  命令: npx @modelcontextprotocol/server-excel    │
│                                                   │
│  🔧 read_data_from_excel  🔧 write_data_to_excel │
│  🔧 apply_formula  🔧 format_range  +5           │
└──────────────────────────────────────────────────┘
```

### 悬停效果（高亮状态）
```
🔧 read_data_from_excel  ← 鼠标悬停
   ↓
   显示Tooltip：
   ┌─────────────────────────────────┐
   │ read_data_from_excel            │
   │                                 │
   │ Read data from Excel worksheet  │
   │ with cell metadata including    │
   │ validation rules.               │
   └─────────────────────────────────┘
```

## 成功标准

- ✅ 一键检查功能正常工作
- ✅ 工具标签正确显示（最多5个）
- ✅ 悬停交互流畅
- ✅ Tooltip内容准确
- ✅ 无性能问题
- ✅ 无UI布局问题

## 测试完成检查清单

- [ ] 一键检查所有服务器功能测试通过
- [ ] 工具标签显示测试通过
- [ ] 悬停交互测试通过  
- [ ] 边界情况测试通过
- [ ] 性能测试通过
- [ ] 无明显bug

---

**测试日期**：2025-10-01  
**测试人员**：___________  
**测试结果**：□ 通过  □ 失败  
**备注**：_________________

