# 多轮对话工具调用测试指南

## 测试目标

验证 AI 在调用 MCP 工具后能够基于工具结果生成最终回答，而不是仅仅显示原始的工具执行结果。

## 测试前准备

1. **确保 MCP 服务器已配置并运行**
   - 例如：Readwise MCP 服务器

2. **确保智能体（Agent）已启用**
   - 智能体配置中需要包含工具调用能力

3. **编译最新代码**
   ```bash
   cd rust-lib/flowy-ai
   cargo build
   ```

## 测试用例

### 测试用例 1: Readwise 搜索

#### 输入
```
请推荐几本 Readwise 中与禅宗相关的书籍
```

#### 期望输出

**第一阶段：工具调用**
```
好的，我会使用 search_readwise_highlights 工具来搜索 Readwise 中与禅宗相关的书籍。

<tool_call>
{
  "id": "call_001",
  "tool_name": "search_readwise_highlights",
  ...
}
</tool_call>
```

**第二阶段：工具执行**
```
<tool_result>
工具执行成功：search_readwise_highlights
结果：[大量 JSON 数据...]
</tool_result>
```

**第三阶段：分隔符**
```
---
```

**第四阶段：AI 最终回答**
```
根据 Readwise 的搜索结果，我为您推荐以下几本与禅宗相关的书籍：

1. **《The Way of Zen》** by Alan Watts
   这本书详细介绍了禅宗的核心思想...

2. **《洞见：从科学到哲学，打开人类的认知真相》** by 罗伯特·赖特
   书中探讨了不同佛教流派的特点...

[AI 基于工具结果生成的自然语言回答]
```

#### ❌ 错误的输出（修复前）
```
好的，我会使用 search_readwise_highlights 工具...

<tool_call>
{...}
</tool_call>

<tool_result>
工具执行成功：search_readwise_highlights
结果：[JSON数据]
</tool_result>

[没有后续的 AI 回答]
```

### 测试用例 2: Excel 操作

#### 输入
```
请读取 /path/to/data.xlsx 文件中 Sheet1 的数据，并告诉我有多少行
```

#### 期望行为

1. AI 调用 `read_data_from_excel` 工具
2. 工具返回 Excel 数据
3. **关键**：AI 分析数据并用自然语言回答
   ```
   根据 Excel 文件的读取结果，Sheet1 中共有 150 行数据。
   ```

### 测试用例 3: 多工具调用

#### 输入
```
比较 Readwise 中关于禅宗和正念冥想的书籍数量
```

#### 期望行为

1. AI 调用两次 `search_readwise_highlights`（禅宗、正念冥想）
2. 两个工具都执行完成
3. **关键**：AI 综合两次工具结果，生成对比性回答
   ```
   根据搜索结果：
   - 禅宗相关书籍：发现 X 本
   - 正念冥想相关书籍：发现 Y 本
   
   结论：[AI 的分析和总结]
   ```

## 关键验证点

### ✅ 成功标志

1. **工具执行成功**
   - 看到 `<tool_result>` 标签
   - 结果包含有效数据

2. **出现分隔符**
   - 看到 `---` 分隔符
   - 表示即将开始第二轮 AI 回答

3. **AI 最终回答**
   - AI 用自然语言总结工具结果
   - 回答直接针对用户的原始问题
   - 不包含原始 JSON 数据

4. **日志确认**
   在应用日志中应该看到：
   ```
   🔧 [TOOL] Tool execution completed: ...
   🔧 [MULTI-TURN] Detected N tool call(s), initiating follow-up AI response
   🔧 [MULTI-TURN] Calling AI with follow-up context (XXX chars)
   🔧 [MULTI-TURN] Follow-up stream started
   🔧 [MULTI-TURN] Follow-up response completed
   ```

### ❌ 失败标志

1. **只有工具结果，没有 AI 回答**
   - 看到 `<tool_result>` 后就结束了
   - 没有 `---` 分隔符
   - 没有自然语言总结

2. **工具结果显示但 AI 不理解**
   - AI 说"我无法访问工具结果"
   - AI 重复提问而不是回答

3. **无限循环**
   - AI 在第二轮又调用了工具
   - 不断重复工具调用

## 调试方法

### 1. 查看日志

在应用日志中搜索：
```
🔧 [MULTI-TURN]
```

### 2. 检查变量

在 `chat.rs` 中可以添加调试输出：
```rust
info!("🔧 [DEBUG] tool_calls_and_results count: {}", tool_calls_and_results.len());
info!("🔧 [DEBUG] follow_up_context: {}", follow_up_context);
```

### 3. 验证系统提示

检查第二轮的系统提示是否正确包含了工具结果：
```rust
info!("🔧 [DEBUG] follow_up_system_prompt: {}", follow_up_system_prompt);
```

## 性能测试

### 测试场景 1: 大量数据

使用返回大量数据的工具（如大型 Excel 文件），验证：
- 系统能否正常处理
- 响应时间是否可接受
- 内存使用是否合理

### 测试场景 2: 慢速工具

模拟慢速工具执行（如网络请求），验证：
- UI 不会冻结
- 可以正常取消
- 超时处理正确

## 边界条件测试

1. **工具执行失败**
   - 工具返回错误
   - AI 应该优雅地处理并告知用户

2. **空结果**
   - 工具返回空数据
   - AI 应该告诉用户"未找到相关内容"

3. **用户中断**
   - 在第一轮或第二轮流式输出时中断
   - 应该能正常停止

4. **没有智能体配置**
   - 不应该触发多轮对话
   - 行为与之前一致

## 回归测试

确保新功能不影响现有功能：

1. **普通聊天**（不涉及工具调用）
   - 应该正常工作
   - 没有性能下降

2. **非智能体模式**
   - 不触发工具调用检测
   - 行为不变

3. **流式输出**
   - 保持流畅
   - 没有卡顿

## 用户体验验证

1. **响应连贯性**
   - 第一轮和第二轮之间过渡自然
   - 分隔符不会引起困惑

2. **信息透明度**
   - 用户能看到工具调用过程
   - 用户能理解 AI 在做什么

3. **回答质量**
   - AI 的最终回答准确
   - 回答直接相关
   - 语言自然流畅

## 已知限制

1. **单次多轮**
   - 当前只支持一次工具调用后的回答
   - 不支持多次往返（避免无限循环）

2. **工具结果长度**
   - 非常长的工具结果可能超出上下文窗口
   - 未来可以添加结果摘要功能

3. **并发工具调用**
   - 多个工具按顺序执行
   - 未来可以优化为并行执行

## 报告问题

如果测试失败，请提供：

1. **输入内容**
   - 用户的原始问题

2. **实际输出**
   - 完整的 AI 回答

3. **日志片段**
   - 包含 `[MULTI-TURN]` 和 `[TOOL]` 的日志

4. **配置信息**
   - 智能体配置
   - MCP 服务器配置

5. **环境信息**
   - 操作系统
   - 应用版本

