# MCP任务规划优化总结

## 概述

本次优化针对AI聊天中MCP端点工具调用的问题进行了全面改进，解决了任务规划阶段只提到端点名字而没有细化到具体工具的问题，并实现了智能化的工具选择和执行机制。

## 主要优化内容

### 1. 增强AI模型对MCP端点工具的理解和选择能力

**文件修改：**
- `lib/plugins/ai_chat/application/task_planner_bloc.dart`
- `lib/plugins/ai_chat/application/task_planner_entities.dart`

**主要改进：**
- 修改了`_generateIntelligentSteps`方法，在任务规划阶段获取所有MCP端点的工具信息
- 为每个任务步骤分配具体的可用工具列表，而不仅仅是端点名称
- 增加了`availableMcpTools`字段到TaskPlan实体，存储端点ID到工具列表的映射
- 添加了`toolAssignments`字段，记录AI选择的工具分配

### 2. 修改TaskStep实体，支持动态工具选择和重试机制

**文件修改：**
- `lib/plugins/ai_chat/application/task_planner_entities.dart`

**主要改进：**
- 为TaskStep添加了`objective`字段，明确步骤目标
- 添加了`availableTools`字段，存储该步骤可用的MCP工具列表
- 增加了重试机制相关字段：`retryCount`、`maxRetries`、`executionHistory`
- 添加了`allowToolSubstitution`字段，支持工具替代选择
- 新增了`McpToolSchema`、`StepExecutionAttempt`等支持数据模型

### 3. 实现子任务执行前的目标告知和执行过程显示功能

**新增文件：**
- `lib/plugins/ai_chat/application/intelligent_task_executor.dart`
- `lib/plugins/ai_chat/application/task_execution_notifier.dart`
- `lib/plugins/ai_chat/presentation/task_execution_progress_widget.dart`

**主要功能：**
- **智能任务执行器**：负责执行任务规划，在每个步骤执行前告知用户目标
- **任务执行通知器**：管理和分发任务执行过程中的通知
- **任务执行进度组件**：在AI聊天界面中实时显示执行状态和进度
- 支持步骤开始、完成、失败等各种通知类型
- 提供详细的执行日志和进度跟踪

### 4. 增强MCP工具调用的智能重试和替代工具选择机制

**新增文件：**
- `lib/plugins/ai_chat/application/enhanced_mcp_tool_service.dart`

**主要功能：**
- **智能工具选择算法**：基于语义匹配、历史性能、可靠性等多维度评分
- **失败重试机制**：支持最多3次重试，包括使用替代工具、调整参数、等待重试等策略
- **工具性能监控**：记录工具调用统计信息，用于优化后续选择
- **适合度评分系统**：综合考虑工具描述匹配、标签匹配、性能表现等因素

### 5. 更新AI聊天界面，支持任务执行过程的实时显示

**文件修改：**
- `lib/plugins/ai_chat/presentation/message/ai_text_message.dart`

**新增文件：**
- `lib/plugins/ai_chat/presentation/enhanced_chat_page.dart`

**主要改进：**
- 在AI消息组件中集成任务执行进度显示
- 创建增强版聊天页面，集成任务规划、执行通知和进度显示
- 添加任务执行状态栏，显示当前活跃任务的实时状态
- 支持任务执行过程的可视化反馈

## 技术架构改进

### 数据流优化
```
用户查询 → 任务规划器 → 获取MCP工具信息 → 智能步骤生成 → 
用户确认 → 智能任务执行器 → 工具选择与调用 → 实时通知 → 
进度显示 → 结果整合
```

### 核心组件关系
- **TaskPlannerBloc**: 负责任务规划和工具信息收集
- **IntelligentTaskExecutor**: 负责智能化任务执行
- **EnhancedMcpToolService**: 负责智能工具选择和调用
- **TaskExecutionNotifier**: 负责执行过程通知管理
- **TaskExecutionProgressWidget**: 负责进度可视化显示

## 关键特性

### 1. 智能工具选择
- 基于步骤目标和工具能力的语义匹配
- 考虑工具历史性能和可靠性
- 支持多维度评分算法

### 2. 自适应重试机制
- 根据错误类型选择不同重试策略
- 支持替代工具自动选择
- 最多3次重试，避免无限循环

### 3. 实时执行反馈
- 步骤执行前的目标告知
- 工具调用过程的实时通知
- 详细的执行日志和进度跟踪

### 4. 用户体验优化
- 直观的进度条和状态显示
- 详细的执行日志查看
- 任务执行状态的实时更新

## 使用方式

### 1. 任务规划阶段
用户在AI聊天中选择MCP端点后，系统会：
- 自动获取所有端点的工具信息
- 基于用户查询智能生成任务步骤
- 为每个步骤分配合适的工具选项

### 2. 任务执行阶段
任务确认后，系统会：
- 在每个步骤执行前告知用户目标
- 智能选择最合适的工具进行调用
- 实时显示执行进度和状态
- 在失败时自动重试或选择替代工具

### 3. 结果展示
- 在AI聊天界面中显示完整的执行过程
- 提供详细的执行日志和结果
- 支持执行历史的查看和分析

## 技术优势

1. **智能化程度高**：从简单的端点选择升级为智能工具匹配
2. **可靠性强**：多重重试机制和替代方案确保任务完成
3. **用户体验好**：实时反馈和进度显示提升交互体验
4. **扩展性强**：模块化设计便于后续功能扩展
5. **性能优化**：工具性能监控和缓存机制提升效率

## 未来扩展方向

1. **机器学习优化**：基于历史数据训练工具选择模型
2. **并行执行**：支持独立步骤的并行执行
3. **用户偏好学习**：记录用户偏好，优化工具选择
4. **高级重试策略**：更智能的错误分析和恢复机制
5. **性能分析**：提供详细的执行性能分析和优化建议

## 总结

本次优化全面解决了MCP任务规划中工具选择不够精确的问题，通过智能化的工具匹配、可靠的重试机制和直观的用户界面，大大提升了AI聊天中MCP工具调用的效率和用户体验。系统现在能够：

- 精确理解用户需求并选择最合适的工具
- 在执行过程中提供实时反馈和进度显示
- 自动处理失败情况并选择替代方案
- 为用户提供完整的执行过程可视化

这些改进使得MCP工具调用从简单的端点选择升级为智能化的任务编排系统，为用户提供了更加可靠和高效的AI助手体验。
