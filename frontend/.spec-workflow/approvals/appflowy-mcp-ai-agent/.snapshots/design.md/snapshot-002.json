{
  "id": "snapshot_1759137647557_0okum7gvt",
  "approvalId": "approval_1759137347510_ciomhqerc",
  "approvalTitle": "AppFlowy MCP支持与AI助手智能体设计文档",
  "version": 2,
  "timestamp": "2025-09-29T09:20:47.557Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# AppFlowy MCP支持与AI助手智能体 — 设计说明书\n\n## 概述\n\n本设计文档描述了为AppFlowy引入Model Context Protocol (MCP)管理能力和AI助手智能体功能的技术实现方案。该功能将在现有AI聊天基础上构建一个可扩展的工具调用框架，支持智能体规划、执行和日志记录，并提供跨平台的配置管理界面。\n\n## 指导文档对齐\n\n### 技术标准 (tech.md)\n- 遵循AppFlowy的Flutter前端 + Rust后端架构模式\n- 使用现有的事件驱动通信机制（AFPlugin/AFPluginDispatcher）\n- 复用现有的KVStorePreferences配置存储系统\n- 遵循现有的BLoC状态管理模式\n- 使用现有的多语言支持框架（EasyLocalization）\n\n### 项目结构 (structure.md)\n- MCP相关代码放置在rust-lib/flowy-ai/src/mcp/目录\n- 智能体相关代码放置在rust-lib/flowy-ai/src/agent/目录\n- Flutter UI组件放置在appflowy_flutter/lib/plugins/ai_chat/目录\n- 设置界面扩展现有的settings页面结构\n- 遵循现有的protobuf定义和事件映射模式\n\n## 代码复用分析\n\n### 现有组件复用\n- **AIManager**: 扩展以支持MCP工具管理和智能体调度\n- **ChatServiceMiddleware**: 复用流式响应处理机制\n- **SettingsAIBloc**: 扩展以支持MCP配置管理\n- **KVStorePreferences**: 复用配置存储和作用域管理\n- **AFPluginDispatcher**: 复用事件分发机制\n- **RustStreamReceiver**: 复用实时数据流处理\n\n### 集成点\n- **现有AI事件系统**: 扩展AIEvent枚举以支持MCP和智能体事件\n- **用户设置系统**: 集成到现有的三层设置界面（服务器端/移动端/工作空间）\n- **聊天界面**: 扩展现有聊天UI以显示智能体执行过程和工具调用结果\n- **数据库存储**: 复用现有的SQLite存储方案保存智能体配置和执行日志\n\n## 架构\n\n整体架构采用分层设计，将MCP管理、智能体调度和工具执行分离为独立模块，通过清晰的接口进行交互。\n\n### 模块化设计原则\n- **单文件职责**: 每个文件处理一个特定的领域或关注点\n- **组件隔离**: 创建小而专注的组件，避免大型单体文件\n- **服务层分离**: 分离数据访问、业务逻辑和表示层\n- **工具模块化**: 将工具分解为专注的单一目的模块\n\n```mermaid\ngraph TD\n    A[Flutter UI Layer] --> B[BLoC State Management]\n    B --> C[Rust Event Bridge]\n    C --> D[AI Manager]\n    D --> E[Agent Scheduler]\n    D --> F[MCP Manager]\n    E --> G[Task Planner]\n    E --> H[Task Executor]\n    F --> I[MCP Client Pool]\n    F --> J[Tool Registry]\n    H --> I\n    G --> K[Tool Selection Engine]\n    K --> J\n    L[Configuration Storage] --> F\n    L --> E\n    M[Execution Logger] --> E\n    M --> H\n```\n\n## 组件和接口\n\n### MCP管理器 (MCPManager)\n- **目的**: 管理MCP服务器连接、工具发现和调用\n- **接口**: \n  - `connect_server(config: MCPServerConfig) -> Result<(), FlowyError>`\n  - `disconnect_server(server_id: String) -> Result<(), FlowyError>`\n  - `list_tools(server_id: String) -> Result<Vec<MCPTool>, FlowyError>`\n  - `call_tool(server_id: String, tool_name: String, params: Value) -> Result<Value, FlowyError>`\n- **依赖**: MCPClient, KVStorePreferences\n- **复用**: 扩展现有的flowy-ai/src/mcp/manager.rs\n\n### 智能体调度器 (AgentScheduler)\n- **目的**: 管理智能体生命周期、任务规划和执行协调\n- **接口**:\n  - `create_agent(config: AgentConfig) -> Result<AgentId, FlowyError>`\n  - `start_conversation(agent_id: AgentId, user_input: String) -> Result<ConversationId, FlowyError>`\n  - `process_message(conversation_id: ConversationId, message: String) -> Result<AgentResponse, FlowyError>`\n- **依赖**: TaskPlanner, TaskExecutor, ExecutionLogger\n- **复用**: 新建组件，复用现有的AI调用机制\n\n### 任务规划器 (TaskPlanner)\n- **目的**: 分析用户问题，生成解决方案和子任务\n- **接口**:\n  - `plan_tasks(problem: String, available_tools: Vec<Tool>) -> Result<TaskPlan, FlowyError>`\n  - `replan_on_failure(failed_task: Task, error: String) -> Result<TaskPlan, FlowyError>`\n- **依赖**: AIManager, ToolRegistry\n- **复用**: 复用现有的AI模型调用机制\n\n### 任务执行器 (TaskExecutor)\n- **目的**: 执行具体的子任务，调用相应的工具\n- **接口**:\n  - `execute_task(task: Task) -> Result<TaskResult, FlowyError>`\n  - `execute_with_retry(task: Task, max_retries: u32) -> Result<TaskResult, FlowyError>`\n- **依赖**: MCPManager, ToolRegistry\n- **复用**: 复用现有的工具调用基础设施\n\n### 工具注册表 (ToolRegistry)\n- **目的**: 管理所有可用工具的元数据和调用接口\n- **接口**:\n  - `register_tool(tool: ToolDefinition) -> Result<(), FlowyError>`\n  - `get_available_tools(agent_id: AgentId) -> Vec<ToolDefinition>`\n  - `get_tool_schema(tool_id: String) -> Result<ToolSchema, FlowyError>`\n- **依赖**: 无\n- **复用**: 新建组件\n\n### 执行日志器 (ExecutionLogger)\n- **目的**: 记录智能体执行过程中的所有操作和结果\n- **接口**:\n  - `log_planning(conversation_id: ConversationId, plan: TaskPlan)`\n  - `log_execution(task_id: TaskId, result: TaskResult)`\n  - `get_conversation_logs(conversation_id: ConversationId) -> Vec<ExecutionLog>`\n- **依赖**: SQLite存储\n- **复用**: 复用现有的数据库访问模式\n\n## 数据模型\n\n### MCP服务器配置 (MCPServerConfig)\n```rust\npub struct MCPServerConfig {\n    pub id: String,\n    pub name: String,\n    pub icon: String,\n    pub transport_type: MCPTransportType,\n    pub is_active: bool,\n    pub description: String,\n    pub created_at: DateTime<Utc>,\n    pub updated_at: DateTime<Utc>,\n    pub stdio_config: Option<MCPStdioConfig>,\n    pub http_config: Option<MCPHttpConfig>,\n}\n\npub enum MCPTransportType {\n    Stdio,\n    Http,\n}\n\npub struct MCPStdioConfig {\n    pub command: String,\n    pub args: Vec<String>,\n    pub env_vars: HashMap<String, String>,\n}\n\npub struct MCPHttpConfig {\n    pub url: String,\n    pub headers: HashMap<String, String>,\n}\n```\n\n### 智能体配置 (AgentConfig)\n```rust\npub struct AgentConfig {\n    pub id: String,\n    pub name: String,\n    pub description: String,\n    pub personality: String,\n    pub available_tools: Vec<String>,\n    pub created_at: DateTime<Utc>,\n    pub updated_at: DateTime<Utc>,\n}\n```\n\n### 任务计划 (TaskPlan)\n```rust\npub struct TaskPlan {\n    pub id: String,\n    pub conversation_id: String,\n    pub problem_description: String,\n    pub tasks: Vec<Task>,\n    pub created_at: DateTime<Utc>,\n}\n\npub struct Task {\n    pub id: String,\n    pub description: String,\n    pub tool_name: String,\n    pub parameters: Value,\n    pub dependencies: Vec<String>,\n    pub status: TaskStatus,\n}\n\npub enum TaskStatus {\n    Pending,\n    InProgress,\n    Completed,\n    Failed,\n}\n```\n\n### 执行日志 (ExecutionLog)\n```rust\npub struct ExecutionLog {\n    pub id: String,\n    pub conversation_id: String,\n    pub log_type: LogType,\n    pub timestamp: DateTime<Utc>,\n    pub content: Value,\n}\n\npub enum LogType {\n    Planning,\n    ToolCall,\n    TaskResult,\n    Error,\n}\n```\n\n## 错误处理\n\n### 错误场景\n1. **MCP连接失败**\n   - **处理**: 记录详细错误信息，提供重试机制，显示连接状态\n   - **用户影响**: 显示连接错误提示，提供手动重连选项\n\n2. **工具调用超时**\n   - **处理**: 设置合理超时时间，实现重试逻辑，记录超时日志\n   - **用户影响**: 显示执行进度，提供取消选项\n\n3. **智能体规划失败**\n   - **处理**: 回退到简单对话模式，记录规划失败原因\n   - **用户影响**: 提示规划失败，继续提供基础AI对话服务\n\n4. **配置验证失败**\n   - **处理**: 提供详细的验证错误信息，高亮错误字段\n   - **用户影响**: 显示具体的配置错误和修复建议\n\n## 测试策略\n\n### 单元测试\n- MCP客户端连接和工具调用测试\n- 智能体规划逻辑测试\n- 任务执行器功能测试\n- 配置验证和存储测试\n\n### 集成测试\n- MCP服务器集成测试（使用模拟MCP服务器）\n- 智能体端到端工作流测试\n- 跨平台配置同步测试\n- 多语言界面测试\n\n### 端到端测试\n- 用户创建和配置智能体的完整流程\n- 智能体解决复杂问题的场景测试\n- MCP工具调用的实际使用场景\n- 错误恢复和重试机制测试\n",
  "fileStats": {
    "size": 8329,
    "lines": 254,
    "lastModified": "2025-09-29T09:15:18.222Z"
  },
  "comments": []
}