# AppFlowy OpenAI SDK集成需求规范

## 1. 项目概述

### 1.1 背景
AppFlowy当前支持两种AI模型类型：
- Ollama本地AI
- OpenAI兼容服务器（使用自定义HTTP客户端）

### 1.2 目标
将"OpenAI兼容服务器"的实现从自定义HTTP客户端改造为使用OpenAI官方Dart SDK，同时保留现有的配置界面和功能。

### 1.3 范围
- 后端：使用OpenAI官方Dart SDK替换当前的HTTP客户端实现
- 前端：保留并增强AI设置界面的配置选项
- 跨平台：支持macOS、Windows和Android
- 多语言：支持简体中文和英文

## 2. 功能需求

### 2.1 全局AI模型类型选择
**需求ID**: REQ-001
**描述**: 用户可以在全局设置中选择使用的AI模型类型
**验收标准**:
- [ ] 在AI设置界面提供下拉框选择"全局使用的模型类型"
- [ ] 支持选项："Ollama本地"和"OpenAI兼容服务器"
- [ ] 选择后进入对应的详细配置界面
- [ ] 配置信息持久化保存
- [ ] 默认启用"AppFlowy Local AI（LAI）功能"

### 2.2 OpenAI兼容服务器聊天模型配置
**需求ID**: REQ-002
**描述**: 用户可以配置OpenAI兼容服务器的聊天模型参数
**验收标准**:
- [ ] 聊天API端点配置（默认：https://api.openai.com/v1）
- [ ] 聊天API密钥配置
- [ ] 聊天模型名称配置（默认：gpt-3.5-turbo）
- [ ] 模型类型配置（支持推理模型和普通模型）
- [ ] 最大tokens配置（默认：4096）
- [ ] 温度配置（默认：0.7）
- [ ] 超时时间配置（默认：30秒）

### 2.3 OpenAI兼容服务器嵌入模型配置
**需求ID**: REQ-003
**描述**: 用户可以独立配置嵌入模型参数
**验收标准**:
- [ ] 嵌入API端点配置（默认：https://api.openai.com/v1）
- [ ] 嵌入API密钥配置
- [ ] 嵌入模型名称配置（默认：text-embedding-ada-002）

### 2.4 模型可用性测试
**需求ID**: REQ-004
**描述**: 用户可以测试配置的模型是否可用
**验收标准**:
- [ ] 提供"测试聊天模型"按钮
- [ ] 提供"测试嵌入模型"按钮
- [ ] 显示测试结果（成功/失败）
- [ ] 显示详细的错误信息和响应时间
- [ ] 测试过程中显示加载状态

### 2.5 配置持久化
**需求ID**: REQ-005
**描述**: 所有配置信息需要持久化保存
**验收标准**:
- [ ] 配置信息保存到本地存储
- [ ] 支持服务器端设置同步
- [ ] 支持移动端设置同步
- [ ] 支持工作空间级别的设置

### 2.6 多平台设置界面
**需求ID**: REQ-006
**描述**: 在不同平台的设置界面都支持配置功能
**验收标准**:
- [ ] 服务器端设置界面支持
- [ ] 移动端设置界面支持
- [ ] 工作空间设置界面支持
- [ ] 界面布局适配不同屏幕尺寸

### 2.7 全局模型使用
**需求ID**: REQ-007
**描述**: 一旦配置了全局模型类型，所有AI功能都使用对应的配置
**验收标准**:
- [ ] AI聊天功能使用全局配置的模型
- [ ] AI问答功能使用全局配置的模型
- [ ] 嵌入功能使用全局配置的嵌入模型
- [ ] 配置变更后立即生效

## 3. 非功能需求

### 3.1 性能需求
- API调用响应时间不超过配置的超时时间
- 配置界面操作响应时间不超过200ms
- 测试功能响应时间不超过10秒

### 3.2 可用性需求
- 界面操作直观易懂
- 错误信息清晰明确
- 支持中英文界面

### 3.3 兼容性需求
- 支持macOS、Windows、Android平台
- 兼容现有的Ollama本地AI功能
- 向后兼容现有的配置数据

### 3.4 安全需求
- API密钥安全存储
- 敏感信息不在日志中显示
- 网络通信使用HTTPS

## 4. 约束条件

### 4.1 技术约束
- 必须使用OpenAI官方Dart SDK
- 保持现有的代码架构和规范
- 不影响现有的Ollama本地AI功能

### 4.2 时间约束
- 每个任务都需要有可视化的产出
- 步步为营，确保每个阶段都可以验证结果

## 5. 验收标准

### 5.1 功能验收
- [ ] 所有配置项都可以正常设置和保存
- [ ] 测试功能能够正确验证模型可用性
- [ ] AI聊天和嵌入功能使用新的SDK实现
- [ ] 多平台设置界面都正常工作

### 5.2 质量验收
- [ ] 代码通过所有现有测试
- [ ] 新增功能有对应的测试覆盖
- [ ] 界面符合AppFlowy的设计规范
- [ ] 支持中英文国际化

## 6. 风险和假设

### 6.1 风险
- OpenAI Dart SDK的API可能与当前实现不完全兼容
- 配置数据迁移可能存在兼容性问题
- 多平台界面适配可能需要额外工作

### 6.2 假设
- OpenAI Dart SDK功能完整且稳定
- 现有的protobuf定义可以复用
- 用户配置数据结构不需要大幅变更
