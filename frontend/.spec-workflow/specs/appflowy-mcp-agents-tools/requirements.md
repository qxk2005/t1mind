# AppFlowy MCP 集成与全局 AI 工具/智能体 — 需求说明（Requirements）

## 概述
- 目标：在 AppFlowy 中原生集成 MCP（Model Context Protocol），并建设“全局 AI 工具/助手智能体”框架，使 AI 可调用 MCP 与其它工具完成问题求解；在聊天中可按需选择 MCP 工具，由“规划器/执行器”自动编排调用，跨平台可用（macOS、Windows、Android），支持中英双语。
- 范围：
  - 全局 MCP 配置管理（新增/编辑/删除/可用性检查/列表展示/激活开关）。
  - 全局 AI 工具与助手智能体框架（工具统一抽象；规划器/执行器；会话与执行日志）。
  - 聊天界面支持选择 MCP 并由助手智能体自动使用工具回答问题。
  - 三类设置界面一致支持（服务器端设置、移动端设置、工作空间设置）。
- 非目标（本期不做）：服务器端托管外部 MCP 实例、远程队列编排、计费系统。

## 术语
- MCP：Model Context Protocol，支持 stdio/SSE 两种传输。
- 工具（Tool）：AI 可调用的能力来源（MCP、AppFlowy 内置文档 CRUD、Web 搜索、远/近端 RAG 等）。
- 助手智能体（Agent）：由全局模型驱动，具备个性设定和可用工具边界，使用“规划器/执行器”解决问题。
- 会话（Session）：围绕同一问题的多轮对话与工具调用过程集合。
- 执行日志（Run Log）：规划、执行、工具 I/O 与结果的分组记录。

## 用户故事（EARS 格式）
1) 当用户在设置中管理 MCP 时，系统应允许用户新增、查看、编辑、删除 MCP，并持久化保存配置与状态。
2) 当用户选择传输方式为“stdio”时，系统应让用户配置“执行命令/参数/环境变量（多组 KV）”。
3) 当用户选择传输方式为“SSE”时，系统应让用户配置“URL/HTTP 头（多组 KV）”。
4) 当用户点击“一键检查”时，系统应根据配置验证 MCP 可用性、获取全部工具列表与 schema，并生成工具配置项（必填/可选、默认值），展示完整 I/O 日志窗口并持久化检查结果。
5) 当用户在聊天输入框旁选择 MCP 时，系统应仅列出“已添加且可用”的 MCP，支持多选或全选。
6) 当用户在聊天发问时，助手智能体应基于会话上下文进行规划，自动挑选并调用所选 MCP 的工具与所需配置完成任务，最终给出回答。
7) 当助手智能体执行工具时，系统应记录规划、调用参数、工具原始输入输出与中间结果，按会话与消息维度分组可检索回看。
8) 当用户在不同设置界面（服务器端/移动端/工作空间）打开 MCP 管理时，系统应提供一致能力与 UI 行为（依平台差异略有裁剪）。
9) 当用户切换语言为简体中文或英文时，系统应完整本地化新功能的 UI 文案与系统消息。
10) 当平台为 Android 时，系统应优先支持 SSE 传输；stdio 模式如受平台限制不可用，应在 UI 上禁用并提示原因。

## 关键功能需求
### 1) 全局 MCP 配置
- 列表字段：名称、执行方式（stdio/SSE）、可用工具名列表（最近检查缓存）、状态（最近检查结果/时间）、是否激活、加入/修改时间、图标。
- 新增/编辑：
  - 基本：图标（选自 AppFlowy 图标库）、名称、传输方式、是否激活、备注。
  - stdio：执行命令、命令行参数（数组）、环境变量（多组 KV）。
  - SSE：URL、HTTP 头（多组 KV）。
- 一键检查：
  - 自动尝试握手与工具发现；
  - 获取所有工具清单与 schema；
  - 将 schema 转为“可编辑 KV 配置项”，生成默认值、标注必填与可选；
  - 弹窗展示全量请求/响应 I/O 原文，用于排障；
  - 持久化：可用性（可用/不可用/错误原因）、工具清单、每个工具的 schema 转换结果与默认配置草稿、检查时间与运行平台信息。

### 2) 全局 AI 工具与助手智能体框架
- 工具抽象：统一类型定义，包含来源（MCP/内置/Web/RAG…）、可调用操作、参数 schema、配置项与权限范围。
- 助手智能体：
  - 字段：称呼、个性化描述（System Prompt/行为约束）、可用工具范围（白名单/黑名单）、默认语言偏好。
  - 规划器：读取会话上下文与工具元数据，产出一步“当前子任务”的计划。
  - 执行器：执行子任务，必要时串联多个工具调用并汇总结果。
- 会话：
  - 将用户每次发问与智能体每次回答，以及期间的规划/调用/结果，统一关联到会话与消息上。
  - 可从历史运行中检索并复用先前工具配置草稿。
- 执行日志：
  - 结构化记录：计划文本、所选工具、输入参数（脱敏）、原始 I/O（可开关）、错误与重试信息、耗时统计。

### 3) 聊天集成
- 输入区新增“MCP 选择器”：列出“已添加且状态可用”的 MCP，可全选/多选。
- 回答逻辑改造为“助手智能体（规划器/执行器）”驱动，能够访问所选 MCP 的工具集合与各自 schema/配置。
- 交互：
  - 执行中可展示“工具调用进行中…”并可查看实时日志概要；
  - 出错时提供“复制排障日志”与“重试/修改配置后重试”。

### 4) 设置界面覆盖
- 服务器端设置、移动端设置、工作空间设置均新增“MCP 与 AI 工具/智能体”分区，具备一致能力：
  - MCP 列表与 CRUD、一键检查；
  - 助手智能体的新增/编辑（称呼、个性、工具范围）；
  - 全局工具源开关（如 Web 搜索、RAG 数据源登记）。
- 平台裁剪：Android 若不支持 stdio，相关 UI 灰化并提示；Windows/macOS 全量支持。

## 数据与持久化
- 存储实体：
  - McpEndpoint：id、name、iconKey、transport、isActive、createdAt、updatedAt、lastCheckAt、lastStatus、toolNames[]、platformNotes、ownerScope（server/mobile/workspace）。
  - McpStdioConfig：endpointId、command、args[]、env[]{key,value}。
  - McpSseConfig：endpointId、url、headers[]{key,value}。
  - McpToolSchema：endpointId、toolName、schema(json)、generatedKvTemplate(json)、requiredKeys[]、optionalKeys[]、defaults(json)。
  - Agent：id、title、personaPrompt、toolAllowlist[]/denylist[]、languagePref、createdAt、updatedAt。
  - AgentSession：id、agentId、createdAt、status。
  - AgentTurn：id、sessionId、role(user/assistant)、content、selectedMcpIds[]、createdAt。
  - AgentRunLog：id、sessionId、turnId、planText、steps[], toolCalls[], ioRaw(json, masked)、durationMs、error(optional)。
- 同步与范围：
  - 工作空间级：Agent、会话与日志；
  - 设备级：stdio 的可执行路径/ENV（因平台差异），允许在同名 Endpoint 下保存“平台特定覆写”；
  - 云/同步策略后续设计不在本期范围。

## 平台与本地化
- 支持：macOS、Windows、Android。
- 传输支持：
  - macOS/Windows：stdio + SSE；
  - Android：SSE（stdio 如受限则禁用）。
- 本地化：简体中文与英文，新增 key 全量进入 i18n 资源；执行日志中的原始 I/O 保持原文，不做机器翻译。

## 安全与隐私
- 环境变量与 HTTP 头中的敏感值采用安全存储与掩码显示；导出/日志中默认脱敏。
- 一键检查与执行日志的“原始 I/O”开关默认关闭，开启时提示风险。
- 进程/网络调用需超时与并发上限防护，避免资源滥用。

## 性能与稳定性
- 一键检查超时默认 20s，可配置；
- 工具调用并发上限默认 3；
- UI 线程无阻塞，长任务使用异步与可取消；
- 为每次工具调用记录耗时分布与错误码，便于优化。

## 可视化里程碑与验收标准
- M1：MCP 列表与 CRUD（含图标选择、激活开关）。
  - 可见界面：设置页新增“MCP”页签；可新增/编辑/删除；多平台显示一致。
- M2：一键检查与日志弹窗。
  - 可见界面：编辑页“检查”按钮，成功展示工具清单与 schema 生成的 KV 配置模板；弹窗显示完整请求/响应；列表状态更新。
- M3：全局工具与助手智能体定义。
  - 可见界面：设置页“助手智能体”页签；可新增智能体并配置可用工具范围与个性描述。
- M4：聊天页 MCP 选择器与代理执行。
  - 可见界面：输入区 MCP 多选器；回答过程可查看“调用进行中/日志概要”；返回结果准确引用工具输出。
- M5：执行日志浏览与检索。
  - 可见界面：会话内可展开查看每轮的规划/工具调用与 I/O（脱敏）。

## 兼容性与回退
- 若所有 MCP 均不可用，聊天回退为“仅模型回答”；
- 若某工具 schema 缺少必填项，执行器跳过该工具并在日志提示；
- 出错时提供重试与导出日志能力。

## 约束与风险
- Android 对本地进程（stdio）支持受限；需在 UI 明示并优先 SSE。
- MCP 服务端实现差异较大，schema 解析需做健壮性与容错。
- 大量原始 I/O 持久化可能导致空间增长，需要保留期限与大小限制。

## 开放问题
- 工作空间与设备级配置的合并/优先级策略的具体规则（建议后续在设计阶段细化）。
- RAG 数据源登记的账户/鉴权统一策略（超出本期）。

