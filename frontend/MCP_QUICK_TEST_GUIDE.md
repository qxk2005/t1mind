# 🚀 MCP 工具发现功能 - 快速测试指南

## ⚡ 5分钟快速测试

### 前提条件

确保你的 Excel MCP 服务器正在运行：
```bash
# 在另一个终端窗口运行
FASTMCP_PORT=8007 uvx excel-mcp-server streamable-http
```

### 测试步骤

#### 1️⃣ 添加 MCP 服务器 (30秒)

1. 打开 AppFlowy
2. 点击左上角头像 → 设置
3. 找到"MCP 配置"菜单项
4. 点击右上角"添加服务器"按钮
5. 填写信息：
   - **名称**: `Excel MCP`
   - **描述**: `Excel操作服务器`
   - **传输类型**: `HTTP`
   - **URL**: `http://localhost:8007/mcp`
6. 点击"测试连接"，等待 ✅ 成功提示
7. 点击"保存"

#### 2️⃣ 连接服务器并自动发现工具 (10秒)

1. 在服务器列表中找到"Excel MCP"
2. 点击右侧的"连接"按钮
3. **观察以下变化**：
   - ✅ 连接图标从灰色圆圈变为绿色勾 ✓
   - ✅ 短暂出现转圈加载动画
   - ✅ **自动出现蓝色工具徽章** `🔧 15` （或其他数量）
   - ✅ **自动出现蓝色查看按钮** 📋

#### 3️⃣ 查看工具列表 (10秒)

1. 点击蓝色的 📋 "查看工具"按钮
2. **检查对话框**：
   - ✅ 弹出 700x600 大小的对话框
   - ✅ 标题显示"Excel MCP - MCP 工具 共 XX 个工具"
   - ✅ 看到工具列表（滚动查看）

#### 4️⃣ 查看工具详情 (20秒)

1. 随便点击一个工具卡片（例如 `read_data_from_excel`）
2. **检查展开内容**：
   - ✅ 显示工具名称和图标 ⚡
   - ✅ 显示工具描述
   - ✅ 显示安全标签（绿色"只读"、红色"破坏性"、橙色"外部"）
   - ✅ 展开后显示"输入参数"
   - ✅ 显示格式化的 JSON Schema（有缩进）

3. 尝试点击另一个工具（例如 `write_data_to_excel`）
   - ✅ 上一个工具自动折叠
   - ✅ 新工具展开显示详情
   - ✅ 如果是写入工具，应该显示红色"破坏性"标签

#### 5️⃣ 测试刷新功能 (可选)

1. 关闭工具列表对话框
2. 在后端停止 MCP 服务器
3. 在 AppFlowy 中点击"断开"
4. 重新启动 MCP 服务器（可能修改工具）
5. 再次点击"连接"
6. 应该重新加载最新的工具列表

## ✅ 成功标志

如果你看到以下所有现象，说明功能完美运行：

- [x] 连接成功后，**2秒内**自动出现工具数量徽章
- [x] 工具徽章显示**准确的数量**（与后端一致）
- [x] 点击查看按钮，能看到**所有工具**
- [x] 每个工具卡片可以**展开/折叠**
- [x] JSON Schema **格式良好**，有缩进，可读性强
- [x] 安全标签**正确显示**（只读=绿、破坏性=红、外部=橙）
- [x] 可以**选择和复制** JSON 文本

## 🐛 常见问题

### 问题1: 连接后没有显示工具徽章

**检查**：
1. 查看控制台日志，搜索"自动加载工具列表"
2. 确认后端返回了工具列表
3. 等待 2-3 秒（可能有网络延迟）

### 问题2: 工具数量为 0

**原因**：
- MCP 服务器可能没有正确实现 `tools/list` 方法
- 后端连接失败

**解决**：
```bash
# 测试后端是否正常
curl -X POST http://localhost:8007/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'
```

### 问题3: 点击查看按钮没反应

**检查**：
1. 确保 `tools.isNotEmpty`（至少有1个工具）
2. 查看控制台是否有错误
3. 尝试重新连接

## 📹 预期效果演示（文字版）

```
[初始状态]
┌─────────────────────────────────────────────┐
│ Excel MCP              [HTTP]  [○]  [🗑️]    │
│ Excel操作服务器                              │
│ URL: http://localhost:8007/mcp              │
│                    [连接] [删除]             │
└─────────────────────────────────────────────┘

↓ 点击"连接"

[连接中]
┌─────────────────────────────────────────────┐
│ Excel MCP  [⟳]        [HTTP]  [⟳]  [🗑️]    │
│ Excel操作服务器                              │
│ URL: http://localhost:8007/mcp              │
│                    [连接中...] [删除]        │
└─────────────────────────────────────────────┘

↓ 1-2秒后

[已连接 + 工具加载完成]
┌─────────────────────────────────────────────┐
│ Excel MCP  [🔧 15]    [HTTP]  [📋]  [✓]  [🗑️]│
│ Excel操作服务器                              │
│ URL: http://localhost:8007/mcp              │
│                    [断开] [删除]             │
└─────────────────────────────────────────────┘
     ↑ 自动出现！      ↑ 自动出现！  ↑ 已连接

↓ 点击 📋 按钮

[工具列表对话框]
┌─────────────────────────────────────────────┐
│ 🔧 Excel MCP - MCP 工具      共 15 个工具  [X]│
├─────────────────────────────────────────────┤
│                                             │
│  ⚡ read_data_from_excel  [只读]        [▼] │
│  从Excel文件读取数据                         │
│  ─────────────────────────────────────      │
│                                             │
│  ⚡ write_data_to_excel  [破坏性]       [▼] │
│  向Excel文件写入数据                         │
│  ─────────────────────────────────────      │
│                                             │
│  ⚡ create_workbook                     [▼] │
│  创建新的Excel工作簿                         │
│  ─────────────────────────────────────      │
│                                             │
│  ... 还有 12 个工具 ...                      │
│                                             │
└─────────────────────────────────────────────┘

↓ 点击第一个工具

[工具详情展开]
┌─────────────────────────────────────────────┐
│  ⚡ read_data_from_excel  [只读]        [▲] │
│  从Excel文件读取数据                         │
│  ┌───────────────────────────────────────┐  │
│  │ 输入参数:                              │  │
│  │ ┌─────────────────────────────────┐   │  │
│  │ │ {                                │   │  │
│  │ │   "type": "object",              │   │  │
│  │ │   "properties": {                │   │  │
│  │ │     "filepath": {                │   │  │
│  │ │       "type": "string",          │   │  │
│  │ │       "title": "Filepath"        │   │  │
│  │ │     },                           │   │  │
│  │ │     "sheet_name": {              │   │  │
│  │ │       "type": "string"           │   │  │
│  │ │     }                            │   │  │
│  │ │   },                             │   │  │
│  │ │   "required": ["filepath"]       │   │  │
│  │ │ }                                │   │  │
│  │ └─────────────────────────────────┘   │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

## 🎓 关键知识点

### 自动加载是如何实现的？

```dart
// mcp_settings_bloc.dart line 163-172
// 连接成功回调中
if (status.isConnected) {
  Log.info('连接成功，自动加载工具列表: $serverId');
  add(MCPSettingsEvent.loadToolList(serverId));  // 自动触发加载
}
```

### 工具数据在哪里存储？

```dart
// BLoC State
Map<String, List<MCPToolPB>> serverTools;
// 例如: serverTools['mcp_123456'] = [tool1, tool2, ...]
```

### UI如何知道显示徽章？

```dart
// workspace_mcp_settings_v2.dart
final tools = state.serverTools[server.id] ?? [];  // 从BLoC获取
if (isConnected && tools.isNotEmpty) {
  // 显示徽章
}
```

## 📊 下一步

如果测试成功，你可以：

1. **添加更多 MCP 服务器**（支持多个）
2. **测试不同的传输类型**（STDIO/SSE/HTTP）
3. **为后续的工具调用功能做准备**

祝测试顺利！🎉



