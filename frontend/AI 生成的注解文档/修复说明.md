# AI 聊天"添加到页面"按钮修复说明

## 问题描述
在 AI 聊天窗口中，点击消息泡泡下方的 "add message to page" 按钮后，不会显示文档列表进行选择。

## 修复内容

### 1. 修复了文档选择器数据加载问题
- **原因**：`SpaceBloc` 需要时间初始化，在初始化完成前 `currentSpace` 为 `null`，导致视图数据未加载
- **解决方案**：添加了初始化等待机制，确保在显示选择器之前 `SpaceBloc` 已完成初始化并加载了视图数据

### 2. 改进了用户体验
- **原来的行为**：如果侧边栏有打开的文档，会自动添加到该文档，不显示选择器
- **新的行为**：总是显示文档选择器，让用户自主选择要添加到哪个文档

### 3. 技术改进
- 使用 `BlocBuilder` 代替 `BlocSelector`，以访问完整的 `SpaceState`
- 添加了 `_ensureSpaceInitializedAndRefresh` 方法，使用 stream 可靠地等待初始化完成（2秒超时）
- 确保在打开 popover 前调用 `refreshSources` 加载视图列表

## 测试步骤

1. 打开 AI 聊天窗口
2. 发送消息并获得 AI 回复
3. 点击 AI 回复消息下方的 "add message to page" 按钮（在"查看执行过程"按钮旁边）
4. **预期结果**：
   - 显示文档选择器弹窗
   - 列出所有可用的文档（Document 类型）
   - 可以搜索和过滤文档
   - 选择文档后，消息会被添加到该文档的末尾

## 修改的文件

- `appflowy_flutter/lib/plugins/ai_chat/presentation/message/ai_message_action_bar.dart`

## 注意事项

- 消息会被添加到文档的**末尾**（这是 `ChatEditDocumentService.addMessagesToPage` 的现有行为）
- 只有 Document 类型的视图会显示在选择器中
- 如果 SpaceBloc 初始化超过 2 秒，会显示空的选择器（避免无限等待）

