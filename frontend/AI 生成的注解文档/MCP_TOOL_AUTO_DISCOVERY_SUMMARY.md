# MCP å·¥å…·è‡ªåŠ¨å‘ç°åŠŸèƒ½æ€»ç»“

## åŠŸèƒ½æ¦‚è¿°

æ™ºèƒ½ä½“ç°åœ¨æ”¯æŒä»å·²é…ç½®çš„ MCP æœåŠ¡å™¨**è‡ªåŠ¨å‘ç°**å¯ç”¨å·¥å…·ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å·¥å…·åˆ—è¡¨ã€‚

## è‡ªåŠ¨å‘ç°çš„ä¸‰ä¸ªè§¦å‘æ—¶æœº

### 1. âœ… åˆ›å»ºæ™ºèƒ½ä½“æ—¶

**æ¡ä»¶**ï¼š
- `available_tools` åˆ—è¡¨ä¸ºç©º
- `enable_tool_calling` è®¾ç½®ä¸º `true`

**è¡Œä¸º**ï¼š
```
â†’ æ‰«ææ‰€æœ‰å·²è¿æ¥çš„ MCP æœåŠ¡å™¨
â†’ æ”¶é›†æ‰€æœ‰å¯ç”¨å·¥å…·
â†’ è‡ªåŠ¨å¡«å……åˆ°æ™ºèƒ½ä½“é…ç½®
â†’ ä¿å­˜é…ç½®
```

**æ—¥å¿—è¾“å‡º**ï¼š
```
[Tool Discovery] å¼€å§‹æ‰«æ 1 ä¸ª MCP æœåŠ¡å™¨...
[Tool Discovery] æ£€æŸ¥æœåŠ¡å™¨: excel-server (çŠ¶æ€: Connected)
ä» MCP æœåŠ¡å™¨ 'excel-server' å‘ç° 20 ä¸ªå·¥å…·
ä¸ºæ–°æ™ºèƒ½ä½“ 'XXX' è‡ªåŠ¨å‘ç°äº† 20 ä¸ªå·¥å…·
```

### 2. âœ… æ›´æ–°æ™ºèƒ½ä½“æ—¶ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰

**æ¡ä»¶**ï¼š
- æ›´æ–°äº† `capabilities` é…ç½®
- `enable_tool_calling` ä¸º `true`
- `available_tools` ä¸ºç©º
- æ»¡è¶³ä»¥ä¸‹ä¹‹ä¸€ï¼š
  - ç°æœ‰é…ç½®çš„å·¥å…·åˆ—è¡¨ä¹Ÿä¸ºç©º
  - `enable_tool_calling` ä» `false` æ”¹ä¸º `true`

**è¡Œä¸º**ï¼š
```
â†’ æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨èƒ½åŠ›å˜æ›´
â†’ è‡ªåŠ¨å‘ç° MCP å·¥å…·
â†’ å¡«å……å·¥å…·åˆ—è¡¨
â†’ ä¿å­˜æ›´æ–°
```

**æ—¥å¿—è¾“å‡º**ï¼š
```
[Agent Update] æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨èƒ½åŠ›å˜æ›´ï¼Œå¼€å§‹è‡ªåŠ¨å‘ç°å·¥å…·...
[Tool Discovery] å¼€å§‹æ‰«æ 1 ä¸ª MCP æœåŠ¡å™¨...
[Agent Update] ä¸ºæ™ºèƒ½ä½“ 'XXX' è‡ªåŠ¨å‘ç°äº† 20 ä¸ªå·¥å…·
```

**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·åˆ›å»ºæ™ºèƒ½ä½“æ—¶å¿˜è®°å¯ç”¨å·¥å…·è°ƒç”¨ï¼Œåæ¥åœ¨è®¾ç½®ä¸­æ‰“å¼€
- ç”¨æˆ·æƒ³åˆ·æ–°æ™ºèƒ½ä½“çš„å·¥å…·åˆ—è¡¨ï¼ˆå¯ä»¥å…ˆæ¸…ç©ºå·¥å…·ç„¶åæ›´æ–°ï¼‰

### 3. âœ… èŠå¤©å¯åŠ¨æ—¶ï¼ˆè¿è¡Œæ—¶å…œåº•ï¼‰

**æ¡ä»¶**ï¼š
- åŠ è½½æ™ºèƒ½ä½“é…ç½®
- `available_tools` ä¸ºç©º
- `enable_tool_calling` ä¸º `true`

**è¡Œä¸º**ï¼š
```
â†’ åœ¨å¼€å§‹èŠå¤©å‰æ£€æŸ¥å·¥å…·åˆ—è¡¨
â†’ å¦‚æœä¸ºç©ºåˆ™è‡ªåŠ¨å‘ç°
â†’ ä¿å­˜æ›´æ–°çš„é…ç½®
â†’ ä½¿ç”¨æ›´æ–°åçš„é…ç½®ç»§ç»­èŠå¤©
```

**æ—¥å¿—è¾“å‡º**ï¼š
```
[Chat] Using agent: XXX (xxx-xxx-xxx)
[Chat] Agent has 0 tools, tool_calling enabled: true
[Chat] æ™ºèƒ½ä½“å·¥å…·åˆ—è¡¨ä¸ºç©ºï¼Œå¼€å§‹è‡ªåŠ¨å‘ç° MCP å·¥å…·...
[Tool Discovery] å¼€å§‹æ‰«æ 1 ä¸ª MCP æœåŠ¡å™¨...
ä¸ºæ™ºèƒ½ä½“ 'XXX' è‡ªåŠ¨å‘ç°å¹¶å¡«å……äº† 20 ä¸ªå·¥å…·
```

## å·¥å…·å‘ç°é€»è¾‘

```rust
async fn discover_available_tools(&self) -> Vec<String> {
    // 1. è·å–æ‰€æœ‰ MCP æœåŠ¡å™¨
    let servers = self.mcp_manager.list_servers().await;
    
    // 2. éå†å·²è¿æ¥çš„æœåŠ¡å™¨
    for server in servers {
        if server.status == Connected {
            // 3. è·å–æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨
            let tools_list = self.mcp_manager.tool_list(&server.server_id).await;
            
            // 4. æ”¶é›†æ‰€æœ‰å·¥å…·åç§°
            for tool in tools_list.tools {
                tool_names.push(tool.name);
            }
        }
    }
    
    // 5. è¿”å›æ‰€æœ‰å‘ç°çš„å·¥å…·
    tool_names
}
```

## å¿«é€Ÿæµ‹è¯•

### æµ‹è¯•åœºæ™¯ 1: åˆ›å»ºæ–°æ™ºèƒ½ä½“

```
1. ç¡®ä¿ Excel MCP æœåŠ¡å™¨å·²è¿æ¥
2. åˆ›å»ºæ–°æ™ºèƒ½ä½“ï¼š
   - åç§°ï¼šå·¥å…·æµ‹è¯•
   - å¯ç”¨"å·¥å…·è°ƒç”¨"ï¼šâœ“
   - ä¸æ‰‹åŠ¨æ·»åŠ å·¥å…·
3. æŸ¥çœ‹æ—¥å¿— â†’ åº”è¯¥çœ‹åˆ°å·¥å…·å‘ç°è¿‡ç¨‹
4. ä½¿ç”¨è¯¥æ™ºèƒ½ä½“èŠå¤©ï¼Œè¯·æ±‚"è¯»å– excel æ–‡ä»¶"
5. è§‚å¯Ÿæ˜¯å¦èƒ½è°ƒç”¨ MCP Excel å·¥å…·
```

### æµ‹è¯•åœºæ™¯ 2: æ›´æ–°ç°æœ‰æ™ºèƒ½ä½“

```
1. é€‰æ‹©ç°æœ‰æ™ºèƒ½ä½“ï¼ˆå¦‚"æ®µå­é«˜æ‰‹"ï¼‰
2. æ‰“å¼€æ™ºèƒ½ä½“è®¾ç½®
3. å°†"å·¥å…·è°ƒç”¨"å¼€å…³ä»å…³é—­æ”¹ä¸ºå¼€å¯
4. ä¿å­˜æ›´æ–°
5. æŸ¥çœ‹æ—¥å¿— â†’ åº”è¯¥çœ‹åˆ°ï¼š
   [Agent Update] æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨èƒ½åŠ›å˜æ›´ï¼Œå¼€å§‹è‡ªåŠ¨å‘ç°å·¥å…·...
6. ä½¿ç”¨è¯¥æ™ºèƒ½ä½“æµ‹è¯•å·¥å…·è°ƒç”¨
```

### æµ‹è¯•åœºæ™¯ 3: èŠå¤©æ—¶è‡ªåŠ¨å‘ç°

```
1. ä½¿ç”¨å·¥å…·åˆ—è¡¨ä¸ºç©ºçš„æ™ºèƒ½ä½“
2. ç›´æ¥å¼€å§‹èŠå¤©
3. æŸ¥çœ‹æ—¥å¿— â†’ åº”è¯¥çœ‹åˆ°ï¼š
   [Chat] æ™ºèƒ½ä½“å·¥å…·åˆ—è¡¨ä¸ºç©ºï¼Œå¼€å§‹è‡ªåŠ¨å‘ç° MCP å·¥å…·...
4. å·¥å…·ä¼šåœ¨èŠå¤©å¼€å§‹å‰è‡ªåŠ¨å¡«å……
```

## é¢„æœŸæ—¥å¿—è¾“å‡º

### å®Œæ•´çš„å·¥å…·å‘ç°æµç¨‹

```
INFO  flowy_ai::ai_manager: [Chat] Using agent: æ®µå­é«˜æ‰‹ (fbe524fc-5fb4-470e-bb0b-c9c98d058860)
INFO  flowy_ai::ai_manager: [Chat] Agent has 0 tools, tool_calling enabled: true
INFO  flowy_ai::ai_manager: [Chat] æ™ºèƒ½ä½“å·¥å…·åˆ—è¡¨ä¸ºç©ºï¼Œå¼€å§‹è‡ªåŠ¨å‘ç° MCP å·¥å…·...
INFO  flowy_ai::ai_manager: [Tool Discovery] å¼€å§‹æ‰«æ 1 ä¸ª MCP æœåŠ¡å™¨...
INFO  flowy_ai::ai_manager: [Tool Discovery] æ£€æŸ¥æœåŠ¡å™¨: excel-mcp (çŠ¶æ€: Connected)
INFO  flowy_ai::ai_manager: ä» MCP æœåŠ¡å™¨ 'excel-mcp' å‘ç° 20 ä¸ªå·¥å…·
INFO  flowy_ai::ai_manager: å…±ä» 1 ä¸ª MCP æœåŠ¡å™¨å‘ç° 20 ä¸ªå¯ç”¨å·¥å…·
INFO  flowy_ai::ai_manager: ä¸ºæ™ºèƒ½ä½“ æ®µå­é«˜æ‰‹ è‡ªåŠ¨å‘ç°å¹¶å¡«å……äº† 20 ä¸ªå·¥å…·
```

## æ•…éšœæ’æŸ¥

### å¦‚æœæ²¡æœ‰çœ‹åˆ°å·¥å…·å‘ç°æ—¥å¿—

æ£€æŸ¥ä»¥ä¸‹æ¡ä»¶ï¼š

1. **æ™ºèƒ½ä½“å·²æœ‰å·¥å…·** â†’ æ—¥å¿—æ˜¾ç¤º `Agent has X tools`ï¼ˆX > 0ï¼‰
   - è§£å†³ï¼šåˆ é™¤æ™ºèƒ½ä½“é‡æ–°åˆ›å»ºï¼Œæˆ–æ¸…ç©ºå·¥å…·åˆ—è¡¨åæ›´æ–°

2. **å·¥å…·è°ƒç”¨æœªå¯ç”¨** â†’ æ—¥å¿—æ˜¾ç¤º `tool_calling enabled: false`
   - è§£å†³ï¼šåœ¨æ™ºèƒ½ä½“è®¾ç½®ä¸­å¯ç”¨"å·¥å…·è°ƒç”¨"å¼€å…³

3. **æ²¡æœ‰ MCP æœåŠ¡å™¨** â†’ æ—¥å¿—æ˜¾ç¤º `å¼€å§‹æ‰«æ 0 ä¸ª MCP æœåŠ¡å™¨`
   - è§£å†³ï¼šåœ¨ MCP è®¾ç½®ä¸­æ·»åŠ å¹¶è¿æ¥æœåŠ¡å™¨

4. **MCP æœåŠ¡å™¨æœªè¿æ¥** â†’ æ—¥å¿—æ˜¾ç¤º `çŠ¶æ€: Disconnected`
   - è§£å†³ï¼šåœ¨ MCP è®¾ç½®ä¸­è¿æ¥æœåŠ¡å™¨

## æŒä¹…åŒ–éªŒè¯

### æ™ºèƒ½ä½“é…ç½®å®Œå…¨æŒä¹…åŒ– âœ…

æ‰€æœ‰é…ç½®ï¼ˆåŒ…æ‹¬èƒ½åŠ›å¼€å…³ï¼‰éƒ½ä¼šæŒä¹…åŒ–åˆ° SQLiteï¼š

```
å­˜å‚¨ç»“æ„:
â”œâ”€â”€ agent_config:agent:{agent_id}
â”‚   â”œâ”€â”€ id, name, description, avatar, personality
â”‚   â”œâ”€â”€ capabilities
â”‚   â”‚   â”œâ”€â”€ enable_planning âœ“
â”‚   â”‚   â”œâ”€â”€ enable_tool_calling âœ“
â”‚   â”‚   â”œâ”€â”€ enable_reflection âœ“
â”‚   â”‚   â”œâ”€â”€ enable_memory âœ“
â”‚   â”‚   â”œâ”€â”€ max_planning_steps
â”‚   â”‚   â”œâ”€â”€ max_tool_calls
â”‚   â”‚   â””â”€â”€ memory_limit
â”‚   â”œâ”€â”€ available_tools (åŠ¨æ€å‘ç°å¹¶ä¿å­˜)
â”‚   â””â”€â”€ status, created_at, updated_at, metadata
â”‚
â””â”€â”€ agent_global_settings
    â”œâ”€â”€ enabled
    â”œâ”€â”€ default_max_planning_steps
    â”œâ”€â”€ default_max_tool_calls
    â””â”€â”€ default_memory_limit
```

### é‡å¯åé…ç½®ä¿æŒ âœ…

é‡å¯åº”ç”¨åï¼š
1. æ™ºèƒ½ä½“é…ç½®ä» SQLite åŠ è½½
2. æ‰€æœ‰èƒ½åŠ›å¼€å…³ä¿æŒåŸæœ‰çŠ¶æ€
3. å·¥å…·åˆ—è¡¨ä¿æŒï¼ˆå¦‚æœä¹‹å‰å·²å‘ç°ï¼‰

## ä¿®å¤çš„æ–‡ä»¶æ¸…å•

### åç«¯ (Rust)
- âœ… `rust-lib/flowy-ai/src/ai_manager.rs`
  - æ·»åŠ  `discover_available_tools()` æ–¹æ³•
  - åœ¨ `create_agent()` ä¸­é›†æˆå·¥å…·å‘ç°
  - åœ¨ `update_agent()` ä¸­é›†æˆå·¥å…·å‘ç°
  - åœ¨ `stream_chat_message()` ä¸­é›†æˆå·¥å…·å‘ç°

- âœ… `rust-lib/flowy-ai/src/agent/config_manager.rs`
  - ä¿®æ”¹éªŒè¯é€»è¾‘ï¼Œå…è®¸ç©ºå·¥å…·åˆ—è¡¨ï¼ˆå¦‚æœå°†è‡ªåŠ¨å‘ç°ï¼‰
  - æ·»åŠ  `auto_populate_agent_tools()` è¾…åŠ©æ–¹æ³•

### å‰ç«¯ (Flutter)
- âœ… `appflowy_flutter/lib/workspace/presentation/settings/workspace/widgets/agent_dialog.dart`
  - ç§»é™¤ç¡¬ç¼–ç çš„ `['default_tool']`
  - è®©åç«¯è‡ªåŠ¨å‘ç°å·¥å…·

## æ€»ç»“

ç°åœ¨æ™ºèƒ½ä½“çš„å·¥å…·å‘ç°æ˜¯**å®Œå…¨è‡ªåŠ¨åŒ–**çš„ï¼š

âœ… åˆ›å»ºæ™ºèƒ½ä½“ â†’ è‡ªåŠ¨å‘ç°å·¥å…·  
âœ… æ›´æ–°æ™ºèƒ½ä½“èƒ½åŠ› â†’ è‡ªåŠ¨å‘ç°å·¥å…·  
âœ… å¯åŠ¨èŠå¤© â†’ è¿è¡Œæ—¶å…œåº•å‘ç°å·¥å…·  
âœ… é…ç½®æŒä¹…åŒ– â†’ èƒ½åŠ›å¼€å…³å’Œå·¥å…·åˆ—è¡¨éƒ½æ­£ç¡®ä¿å­˜  
âœ… é…ç½®é©±åŠ¨ â†’ å®Œå…¨åŸºäºå®é™…çš„ MCP æœåŠ¡å™¨é…ç½®

ç”¨æˆ·ä½“éªŒï¼š**é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨ï¼** ğŸ‰

