# å·¥å…·ç»“æœé•¿åº¦å¯é…ç½®åŒ– - å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åç«¯é…ç½®å­—æ®µ

**æ–‡ä»¶**: `rust-lib/flowy-ai/resources/proto/entities.proto`
- âœ… å·²å­˜åœ¨ `max_tool_result_length` å­—æ®µï¼ˆç¬¬ 8 ä¸ªå­—æ®µï¼‰

**æ–‡ä»¶**: `rust-lib/flowy-ai/src/entities.rs`
- âœ… æ·»åŠ äº† `max_tool_result_length: i32` å­—æ®µ
- âœ… æ·»åŠ äº†è¯¦ç»†çš„æ–‡æ¡£æ³¨é‡Š

### 2. å¤šè½®å¯¹è¯é€»è¾‘æ›´æ–°

**æ–‡ä»¶**: `rust-lib/flowy-ai/src/chat.rs`

**æ”¹åŠ¨**ï¼š
```rust
// âŒ ä¹‹å‰ï¼šç¡¬ç¼–ç 
const MAX_RESULT_LENGTH: usize = 4000;

// âœ… ç°åœ¨ï¼šä»é…ç½®è¯»å–
let max_result_length = agent_config.as_ref()
  .map(|config| {
    let configured = config.capabilities.max_tool_result_length;
    if configured <= 0 {
      4000 // é»˜è®¤å€¼
    } else if configured < 1000 {
      1000 // æœ€å°å€¼
    } else {
      configured as usize
    }
  })
  .unwrap_or(4000);
```

### 3. é…ç½®éªŒè¯

- âœ… é»˜è®¤å€¼ï¼š4000 å­—ç¬¦
- âœ… æœ€å°å€¼ï¼š1000 å­—ç¬¦
- âœ… è‡ªåŠ¨ä¿®æ­£ï¼š0 æˆ–è´Ÿæ•° â†’ 4000ï¼Œ< 1000 â†’ 1000
- âœ… æ—¥å¿—è¾“å‡ºï¼šæ˜¾ç¤ºå®é™…ä½¿ç”¨çš„å€¼

## ğŸ“Š é…ç½®æ•ˆæœ

### ç¤ºä¾‹ 1: ä½¿ç”¨é»˜è®¤å€¼

```rust
// é…ç½®
agent_config.capabilities.max_tool_result_length = 0; // æˆ–ä¸è®¾ç½®

// æ—¥å¿—è¾“å‡º
ğŸ”§ [MULTI-TURN] Using max_tool_result_length: 4000 chars
```

### ç¤ºä¾‹ 2: è‡ªå®šä¹‰çŸ­ç»“æœ

```rust
// é…ç½®
agent_config.capabilities.max_tool_result_length = 2000;

// æ—¥å¿—è¾“å‡º
ğŸ”§ [MULTI-TURN] Using max_tool_result_length: 2000 chars
ğŸ”§ [MULTI-TURN] Truncating tool result from 35870 to 2000 chars
```

### ç¤ºä¾‹ 3: å¤§ä¸Šä¸‹æ–‡æ¨¡å‹

```rust
// é…ç½®ï¼ˆé€‚åˆ Claudeã€GPT-4 ç­‰ï¼‰
agent_config.capabilities.max_tool_result_length = 16000;

// æ—¥å¿—è¾“å‡º
ğŸ”§ [MULTI-TURN] Using max_tool_result_length: 16000 chars
```

## ğŸ¯ æ¨èé…ç½®

| ä½¿ç”¨åœºæ™¯ | æ¨èå€¼ | è¯´æ˜ |
|---------|--------|------|
| å°å‹æ¨¡å‹ | 1000-2000 | æœ¬åœ°æ¨¡å‹ã€GPT-3.5 ç­‰ |
| æ ‡å‡†æ¨¡å‹ | 4000 | GPT-4ã€Claudeï¼ˆé»˜è®¤ï¼‰ |
| å¤§ä¸Šä¸‹æ–‡ | 8000-16000 | Claude-100Kã€GPT-4-32K ç­‰ |

## ğŸ“ ç”¨æˆ·é…ç½®æ–¹æ³•

### æ–¹æ³• 1: é€šè¿‡æ™ºèƒ½ä½“è®¾ç½®é¡µé¢ï¼ˆUIï¼‰

**ä½ç½®**: è®¾ç½® â†’ AI â†’ æ™ºèƒ½ä½“é…ç½® â†’ èƒ½åŠ›è®¾ç½®

```
[ ] å¯ç”¨ä»»åŠ¡è§„åˆ’
[x] å¯ç”¨å·¥å…·è°ƒç”¨
[ ] å¯ç”¨åæ€æœºåˆ¶
[x] å¯ç”¨ä¼šè¯è®°å¿†

å·¥å…·ç»“æœæœ€å¤§é•¿åº¦: [  4000  ] å­—ç¬¦
                    â†‘ å¯ä¿®æ”¹æ­¤å€¼
```

**æ³¨æ„**: UI é…ç½®åŠŸèƒ½å¾…å‰ç«¯å®ç°

### æ–¹æ³• 2: ç›´æ¥ä¿®æ”¹é…ç½®ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰

ç¼–è¾‘æ™ºèƒ½ä½“é…ç½® JSONï¼š
```json
{
  "name": "æˆ‘çš„åŠ©æ‰‹",
  "capabilities": {
    "enable_tool_calling": true,
    "max_tool_result_length": 8000
  }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **è®¾ç½®é…ç½®**
   ```rust
   agent_config.capabilities.max_tool_result_length = 2000;
   ```

2. **è§¦å‘å·¥å…·è°ƒç”¨**
   ```
   ç”¨æˆ·: æ¨èå‡ æœ¬ Readwise ä¸­ä¸ç¦…å®—ç›¸å…³çš„ä¹¦ç±
   ```

3. **æ£€æŸ¥æ—¥å¿—**
   ```
   INFO  ğŸ”§ [MULTI-TURN] Using max_tool_result_length: 2000 chars
   INFO  ğŸ”§ [MULTI-TURN] Truncating tool result from 35870 to 2000 chars
   ```

4. **éªŒè¯ç»“æœ**
   - AI èƒ½åŸºäºæˆªæ–­ç»“æœç”Ÿæˆå›ç­”
   - å›ç­”è´¨é‡å¯æ¥å—
   - ä¸ä¼šå› ä¸Šä¸‹æ–‡è¿‡é•¿è€Œå¤±è´¥

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é…ç½®ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥**:
- æ™ºèƒ½ä½“é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
- æ—¥å¿—æ˜¯å¦æ˜¾ç¤º `Using max_tool_result_length`

**è§£å†³**:
```bash
# æŸ¥çœ‹æ—¥å¿—
grep "max_tool_result_length" app.log
```

### é—®é¢˜ 2: ä¸Šä¸‹æ–‡ä»ç„¶è¿‡é•¿

**ç°è±¡**: çœ‹åˆ°è­¦å‘Šæ—¥å¿—
```
WARN ğŸ”§ [MULTI-TURN] âš ï¸ System prompt is very long (42175 chars)
```

**åŸå› **: 
- ç³»ç»Ÿæç¤ºè¯æœ¬èº«å¾ˆé•¿
- å¤šä¸ªå·¥å…·ç»“æœç´¯åŠ 
- é…ç½®å€¼è¿‡å¤§

**è§£å†³**:
- å‡å° `max_tool_result_length` å€¼
- ä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯é•¿åº¦
- ä½¿ç”¨æ”¯æŒæ›´å¤§ä¸Šä¸‹æ–‡çš„æ¨¡å‹

### é—®é¢˜ 3: æˆªæ–­åå›ç­”è´¨é‡ä¸‹é™

**åŸå› **: é‡è¦ä¿¡æ¯è¢«æˆªæ–­

**è§£å†³**:
- å¢åŠ  `max_tool_result_length` å€¼
- ä¼˜åŒ–å·¥å…·ï¼Œè¿”å›æ›´ç²¾ç®€çš„ç»“æœ
- è®©å·¥å…·è¿”å›æ‘˜è¦è€ŒéåŸå§‹æ•°æ®

## ğŸ“š ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `rust-lib/flowy-ai/resources/proto/entities.proto` | Protobuf å®šä¹‰ |
| `rust-lib/flowy-ai/src/entities.rs` | Rust æ•°æ®ç»“æ„ |
| `rust-lib/flowy-ai/src/chat.rs` | å¤šè½®å¯¹è¯å®ç° |
| `MAX_TOOL_RESULT_LENGTH_CONFIG.md` | è¯¦ç»†é…ç½®æ–‡æ¡£ |

## âœ… éªŒè¯æ¸…å•

- [x] Protobuf å­—æ®µå·²å®šä¹‰
- [x] Rust ç»“æ„ä½“å·²æ›´æ–°
- [x] å¤šè½®å¯¹è¯é€»è¾‘å·²æ›´æ–°
- [x] é…ç½®éªŒè¯é€»è¾‘å·²å®ç°
- [x] æ—¥å¿—è¿½è¸ªå·²æ·»åŠ 
- [x] UTF-8 å®‰å…¨æˆªæ–­å·²å®ç°
- [x] æ–‡æ¡£å·²åˆ›å»º
- [ ] å‰ç«¯ UI é…ç½®ç•Œé¢ï¼ˆå¾…å®ç°ï¼‰
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

## ğŸš€ ä¸‹ä¸€æ­¥

1. **å‰ç«¯å®ç°**
   - åœ¨æ™ºèƒ½ä½“è®¾ç½®é¡µé¢æ·»åŠ é…ç½®è¾“å…¥æ¡†
   - ç»‘å®šåˆ° `agent_config.capabilities.max_tool_result_length`

2. **æµ‹è¯•éªŒè¯**
   - ä¸åŒé…ç½®å€¼çš„æ•ˆæœæµ‹è¯•
   - å„ç§æ¨¡å‹çš„å…¼å®¹æ€§æµ‹è¯•

3. **ç”¨æˆ·æ–‡æ¡£**
   - åœ¨ç”¨æˆ·æ‰‹å†Œä¸­æ·»åŠ é…ç½®è¯´æ˜
   - æä¾›é…ç½®æ¨èæŒ‡å—

---

**å®ç°æ—¶é—´**: 2025-10-03  
**çŠ¶æ€**: âœ… åç«¯å®Œæˆï¼Œå‰ç«¯å¾…å®ç°  
**å…¼å®¹æ€§**: å‘åå…¼å®¹ï¼ˆé»˜è®¤å€¼ 4000ï¼‰

